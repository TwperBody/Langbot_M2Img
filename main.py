# Auto generated by LangBot Plugin SDK.
# Please refer to https://docs.langbot.app/en/plugin/dev/tutor.html for more details.
from __future__ import annotations

import os
import base64
import tempfile
from typing import Any

from langbot_plugin.api.definition.plugin import BasePlugin
from langbot_plugin.api.definition.components.common.event_listener import BaseComponent
from langbot_plugin.api.definition.components.common.event_listener import EventListener
from langbot_plugin.api.entities.context import EventContext
from langbot_plugin.api.entities.events import PersonCommandSent, GroupCommandSent
from langbot_plugin.api.entities.events import PersonMessageReceived, GroupMessageReceived

# å¯¼å…¥é…ç½®
from config import DEFAULT_CONFIG, IMG_CONFIG, MARKDOWN_CONFIG, HTML_TEMPLATE, PLUGIN_CONFIG

# Markdownç›¸å…³å¯¼å…¥
from markdown import markdown

# å°è¯•å¯¼å…¥HTMLè½¬å›¾ç‰‡åº“ï¼ˆä¼˜å…ˆçº§ï¼špydf > imgkitï¼‰
HTML_TO_IMAGE_ENGINE = None
try:
    import pydf
    HTML_TO_IMAGE_ENGINE = 'pydf'
    print("âœ… ä½¿ç”¨ pydf (å†…ç½®wkhtmltopdf) å¼•æ“")
except ImportError:
    try:
        import imgkit
        HTML_TO_IMAGE_ENGINE = 'imgkit'
        print("âœ… ä½¿ç”¨ imgkit (ç³»ç»Ÿwkhtmltopdf) å¼•æ“")
    except ImportError:
        print("âŒ æœªæ‰¾åˆ°HTMLè½¬å›¾ç‰‡å¼•æ“")

class Markdown2IMGPlugin(BasePlugin):
    """Markdownè½¬å›¾ç‰‡æ’ä»¶ - å°†Markdownæ–‡æœ¬æ¸²æŸ“ä¸ºå›¾ç‰‡è¾“å‡º"""

    def __init__(self):
        super().__init__()
        self.config = DEFAULT_CONFIG

    async def initialize(self) -> None:
        """æ’ä»¶åˆå§‹åŒ–"""
        try:
            # æ£€æŸ¥ç³»ç»Ÿä¾èµ–
            self._check_dependencies()
            # åŠ è½½ç”¨æˆ·é…ç½®
            self._load_user_config()
            print("Markdown2IMG æ’ä»¶åˆå§‹åŒ–å®Œæˆ")
        except Exception as e:
            print(f"æ’ä»¶åˆå§‹åŒ–å¤±è´¥: {e}")
            raise

    def _load_user_config(self):
        """åŠ è½½ç”¨æˆ·é…ç½®"""
        try:
            # ä»LangBoté…ç½®ç³»ç»Ÿè·å–ç”¨æˆ·é…ç½®
            # åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œapå¯èƒ½æœªåˆå§‹åŒ–
            if not hasattr(self, 'ap') or self.ap is None:
                print("è°ƒè¯•æ¨¡å¼ï¼šapæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
                return
            
            user_config = self.ap.get_config()
            
            # æ›´æ–°å›¾ç‰‡é…ç½®
            if 'image_width' in user_config:
                IMG_CONFIG['width'] = user_config['image_width']
            if 'image_format' in user_config:
                IMG_CONFIG['format'] = user_config['image_format']
            if 'zoom_factor' in user_config:
                IMG_CONFIG['zoom'] = user_config['zoom_factor']
            if 'jpg_quality' in user_config:
                IMG_CONFIG['quality'] = user_config['jpg_quality']
            
            # æ›´æ–°MarkdownåŠŸèƒ½å¼€å…³
            if 'enable_math' in user_config:
                if not user_config['enable_math'] and 'mdx_math' in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].remove('mdx_math')
                elif user_config['enable_math'] and 'mdx_math' not in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].append('mdx_math')
            
            if 'enable_code_highlight' in user_config:
                if not user_config['enable_code_highlight'] and 'codehilite' in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].remove('codehilite')
                elif user_config['enable_code_highlight'] and 'codehilite' not in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].append('codehilite')
            
            if 'enable_tables' in user_config:
                if not user_config['enable_tables'] and 'tables' in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].remove('tables')
                elif user_config['enable_tables'] and 'tables' not in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].append('tables')
            
            if 'enable_footnotes' in user_config:
                if not user_config['enable_footnotes'] and 'footnotes' in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].remove('footnotes')
                elif user_config['enable_footnotes'] and 'footnotes' not in MARKDOWN_CONFIG['extensions']:
                    MARKDOWN_CONFIG['extensions'].append('footnotes')
            
            # æ›´æ–°æ’ä»¶è¡Œä¸ºé…ç½®
            if 'auto_convert' in user_config:
                PLUGIN_CONFIG['auto_convert'] = user_config['auto_convert']
            if 'min_text_length' in user_config:
                PLUGIN_CONFIG['min_text_length'] = user_config['min_text_length']
            if 'max_text_length' in user_config:
                PLUGIN_CONFIG['max_text_length'] = user_config['max_text_length']
            if 'cache_enabled' in user_config:
                PLUGIN_CONFIG['cache_enabled'] = user_config['cache_enabled']
            if 'cache_ttl' in user_config:
                PLUGIN_CONFIG['cache_ttl'] = user_config['cache_ttl']
            if 'temp_file_cleanup' in user_config:
                PLUGIN_CONFIG['temp_file_cleanup'] = user_config['temp_file_cleanup']
            if 'log_level' in user_config:
                PLUGIN_CONFIG['log_level'] = user_config['log_level']
            
            print(f"ç”¨æˆ·é…ç½®åŠ è½½å®Œæˆ: {user_config}")
        except Exception as e:
            print(f"åŠ è½½ç”¨æˆ·é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®: {e}")

    def _check_dependencies(self):
        """æ£€æŸ¥ç³»ç»Ÿä¾èµ–"""
        if HTML_TO_IMAGE_ENGINE == 'pydf':
            try:
                # æ£€æŸ¥pydfæ˜¯å¦å¯ç”¨
                test_html = '<html><body>test</body></html>'
                pdf_content = pydf.generate_pdf(test_html)
                if pdf_content:
                    print("âœ… pydf (å†…ç½®wkhtmltopdf) ä¾èµ–æ£€æŸ¥é€šè¿‡")
                else:
                    raise Exception("pydf ç”Ÿæˆæµ‹è¯•å¤±è´¥")
            except Exception as e:
                print(f"âŒ pydf ä¾èµ–æ£€æŸ¥å¤±è´¥: {e}")
                print("âš ï¸  æ’ä»¶åŠŸèƒ½å°†å—é™")
        
        elif HTML_TO_IMAGE_ENGINE == 'imgkit':
            try:
                # æ£€æŸ¥imgkitæ˜¯å¦å¯ç”¨
                imgkit.from_string('<html><body>test</body></html>', 'test.png')
                os.remove('test.png') if os.path.exists('test.png') else None
                print("âœ… imgkit (ç³»ç»Ÿwkhtmltopdf) ä¾èµ–æ£€æŸ¥é€šè¿‡")
            except Exception as e:
                print(f"âŒ imgkit ä¾èµ–æ£€æŸ¥å¤±è´¥:\n{e}")
                print("\nğŸ“‹ å®‰è£…æŒ‡å—:")
                print("Windows: https://wkhtmltopdf.org/downloads.html")
                print("macOS: brew install --cask wkhtmltopdf")  
                print("Ubuntu/Debian: sudo apt-get install wkhtmltopdf")
                print("CentOS/RHEL: sudo yum install wkhtmltopdf")
                print("\nâš ï¸  æ’ä»¶åŠŸèƒ½å°†å—é™ï¼Œè¯·å®‰è£…åé‡å¯æ’ä»¶")
        
        else:
            print("âŒ æœªæ‰¾åˆ°å¯ç”¨çš„HTMLè½¬å›¾ç‰‡å¼•æ“")
            print("\nğŸ“‹ è¯·å®‰è£…ä»¥ä¸‹åŒ…ä¹‹ä¸€:")
            print("pip install python-pdf  # æ¨èï¼šå†…ç½®wkhtmltopdf")
            print("pip install imgkit      # éœ€è¦ç³»ç»Ÿå®‰è£…wkhtmltopdf")
            print("\nâš ï¸  æ’ä»¶åŠŸèƒ½å°†å—é™")

    async def cleanup(self) -> None:
        """æ’ä»¶æ¸…ç†"""
        print("Markdown2IMG æ’ä»¶æ¸…ç†å®Œæˆ")

    def convert_markdown_to_image(self, markdown_text: str, **kwargs) -> str:
        """
        å°†Markdownæ–‡æœ¬è½¬æ¢ä¸ºå›¾ç‰‡çš„base64ç¼–ç 
        
        Args:
            markdown_text: Markdownæ–‡æœ¬å†…å®¹
            **kwargs: å¯é€‰å‚æ•°
                - format: è¾“å‡ºæ ¼å¼ (png/jpg)
                - width: å›¾ç‰‡å®½åº¦
                - zoom: ç¼©æ”¾æ¯”ä¾‹
                - quality: JPGè´¨é‡
        
        Returns:
            str: å›¾ç‰‡çš„base64ç¼–ç ï¼Œå¤±è´¥æ—¶è¿”å›ç©ºå­—ç¬¦ä¸²
        """
        try:
            # å‚æ•°éªŒè¯
            if not markdown_text or len(markdown_text.strip()) < PLUGIN_CONFIG['min_text_length']:
                print(f"æ–‡æœ¬é•¿åº¦ä¸è¶³: {len(markdown_text)}")
                return ""
            
            if len(markdown_text) > PLUGIN_CONFIG['max_text_length']:
                print(f"æ–‡æœ¬é•¿åº¦è¶…é™: {len(markdown_text)}")
                return ""
            
            # åˆå¹¶é…ç½®
            img_settings = IMG_CONFIG.copy()
            img_settings.update(kwargs)
            
            # éªŒè¯æ ¼å¼
            if img_settings['format'] not in self.config['supported_formats']:
                print(f"ä¸æ”¯æŒçš„æ ¼å¼: {img_settings['format']}")
                return ""
            
            print(f"å¼€å§‹è½¬æ¢Markdownæ–‡æœ¬ï¼Œé•¿åº¦: {len(markdown_text)}")
            
            # è½¬æ¢Markdownä¸ºHTML
            html_content = (
                HTML_TEMPLATE['front'] 
                + markdown(
                    text=markdown_text, 
                    extensions=MARKDOWN_CONFIG['extensions'], 
                    extension_configs=MARKDOWN_CONFIG['extension_configs']
                )
                + HTML_TEMPLATE['end']
            )
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            with tempfile.NamedTemporaryFile(
                suffix=f'.{img_settings["format"]}', 
                delete=False
            ) as temp_file:
                temp_path = temp_file.name
            
            try:
                # æ ¹æ®å¯ç”¨å¼•æ“é€‰æ‹©è½¬æ¢æ–¹æ³•
                if HTML_TO_IMAGE_ENGINE == 'pydf':
                    # ä½¿ç”¨pydfæ¸²æŸ“HTMLä¸ºPDFï¼Œç„¶åè½¬ä¸ºå›¾ç‰‡
                    success = self._convert_with_pydf(html_content, temp_path, img_settings)
                elif HTML_TO_IMAGE_ENGINE == 'imgkit':
                    # ä½¿ç”¨imgkitæ¸²æŸ“HTMLä¸ºå›¾ç‰‡
                    success = self._convert_with_imgkit(html_content, temp_path, img_settings)
                else:
                    print("âŒ æ— å¯ç”¨çš„HTMLè½¬å›¾ç‰‡å¼•æ“")
                    return ""
                
                if not success:
                    return ""
                
                # è¯»å–å›¾ç‰‡å¹¶è½¬æ¢ä¸ºbase64
                with open(temp_path, 'rb') as img_file:
                    img_base64 = base64.b64encode(img_file.read()).decode()
                
                print(f"Markdownè½¬å›¾ç‰‡æˆåŠŸï¼Œæ ¼å¼: {img_settings['format']}")
                return img_base64
                
            finally:
                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                if PLUGIN_CONFIG['temp_file_cleanup'] and os.path.exists(temp_path):
                    os.remove(temp_path)
            
        except Exception as e:
            print(f"Markdownè½¬å›¾ç‰‡å¤±è´¥: {e}")
            return ""

    def _convert_with_pydf(self, html_content: str, temp_path: str, img_settings: dict) -> bool:
        """ä½¿ç”¨pydfå¼•æ“è½¬æ¢HTMLä¸ºå›¾ç‰‡"""
        try:
            # pydfç”ŸæˆPDF
            pdf_content = pydf.generate_pdf(html_content, 
                                          page_size='A4',
                                          margin_top='0.75in',
                                          margin_bottom='0.75in',
                                          margin_left='0.75in', 
                                          margin_right='0.75in')
            
            if not pdf_content:
                print("âŒ pydfç”ŸæˆPDFå¤±è´¥")
                return False
            
            # ç”±äºpydfåªèƒ½ç”ŸæˆPDFï¼Œæˆ‘ä»¬éœ€è¦å°†PDFè½¬æ¢ä¸ºå›¾ç‰‡
            # è¿™éœ€è¦é¢å¤–çš„PDFè½¬å›¾ç‰‡åº“ï¼Œå¦‚pdf2image
            try:
                from pdf2image import convert_from_bytes
                # å°†PDFè½¬æ¢ä¸ºå›¾ç‰‡
                images = convert_from_bytes(pdf_content, dpi=150)
                if images:
                    # ä¿å­˜ç¬¬ä¸€é¡µä¸ºå›¾ç‰‡
                    image = images[0]
                    if img_settings['format'] == 'jpg':
                        image.save(temp_path, 'JPEG', quality=img_settings.get('quality', 90))
                    else:
                        image.save(temp_path, 'PNG')
                    return True
                else:
                    print("âŒ PDFè½¬å›¾ç‰‡å¤±è´¥ï¼šæ— å›¾ç‰‡ç”Ÿæˆ")
                    return False
            except ImportError:
                print("âŒ ç¼ºå°‘pdf2imageåº“ï¼Œæ— æ³•ä½¿ç”¨pydfå¼•æ“")
                print("è¯·å®‰è£…: pip install pdf2image")
                return False
                
        except Exception as e:
            print(f"âŒ pydfè½¬æ¢å¤±è´¥: {e}")
            return False

    def _convert_with_imgkit(self, html_content: str, temp_path: str, img_settings: dict) -> bool:
        """ä½¿ç”¨imgkitå¼•æ“è½¬æ¢HTMLä¸ºå›¾ç‰‡"""
        try:
            imgkit.from_string(html_content, temp_path, options=img_settings)
            return True
        except Exception as e:
            print(f"âŒ imgkitè½¬æ¢å¤±è´¥: {e}")
            return False

# åˆ›å»ºæ’ä»¶å®ä¾‹
plugin = Markdown2IMGPlugin()

class TestMarkdownConverter(EventListener):
    """æµ‹è¯•Markdownè½¬æ¢å™¨çš„å‘½ä»¤ç»„ä»¶"""
    
    def __init__(self):
        super().__init__()
        
        # æ³¨å†Œå‘½ä»¤å¤„ç†å™¨
        @self.handler(PersonCommandSent)
        async def handle_person_command(ctx: EventContext):
            await self._handle_command(ctx)
        
        @self.handler(GroupCommandSent)
        async def handle_group_command(ctx: EventContext):
            await self._handle_command(ctx)
    
    async def _handle_command(self, ctx: EventContext):
        """å¤„ç†å‘½ä»¤"""
        event = ctx.event
        command = event.message.text.strip()
        
        # æ£€æŸ¥å‘½ä»¤
        if command.startswith('!md '):
            markdown_text = command[4:]  # ç§»é™¤ "!md " å‰ç¼€
            
            # è·å–æ’ä»¶å®ä¾‹
            plugin: Markdown2IMGPlugin = ctx.get_plugin_instance()
            
            # è½¬æ¢Markdownä¸ºå›¾ç‰‡
            image_base64 = plugin.convert_markdown_to_image(markdown_text)
            
            if image_base64:
                # å‘é€å›¾ç‰‡
                from langbot_plugin.api.entities.primitives import ImageElement
                image_element = ImageElement(base64=image_base64)
                await ctx.reply([image_element])
            else:
                await ctx.reply("è½¬æ¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥Markdownæ ¼å¼å’Œç³»ç»Ÿé…ç½®")
        
        elif command == '!md-config':
            # æ˜¾ç¤ºå½“å‰é…ç½®
            plugin: Markdown2IMGPlugin = ctx.get_plugin_instance()
            config_info = f"""
å½“å‰æ’ä»¶é…ç½®ï¼š

å›¾ç‰‡è®¾ç½®ï¼š
â€¢ å®½åº¦: {IMG_CONFIG['width']}px
â€¢ æ ¼å¼: {IMG_CONFIG['format']}
â€¢ ç¼©æ”¾: {IMG_CONFIG['zoom']}x
â€¢ JPGè´¨é‡: {IMG_CONFIG['quality']}

åŠŸèƒ½å¼€å…³ï¼š
â€¢ æ•°å­¦å…¬å¼: {'âœ“' if 'mdx_math' in MARKDOWN_CONFIG['extensions'] else 'âœ—'}
â€¢ ä»£ç é«˜äº®: {'âœ“' if 'codehilite' in MARKDOWN_CONFIG['extensions'] else 'âœ—'}
â€¢ è¡¨æ ¼æ”¯æŒ: {'âœ“' if 'tables' in MARKDOWN_CONFIG['extensions'] else 'âœ—'}
â€¢ è„šæ³¨æ”¯æŒ: {'âœ“' if 'footnotes' in MARKDOWN_CONFIG['extensions'] else 'âœ—'}

è¡Œä¸ºè®¾ç½®ï¼š
â€¢ è‡ªåŠ¨è½¬æ¢: {'âœ“' if PLUGIN_CONFIG['auto_convert'] else 'âœ—'}
â€¢ æœ€å°é•¿åº¦: {PLUGIN_CONFIG['min_text_length']}å­—ç¬¦
â€¢ æœ€å¤§é•¿åº¦: {PLUGIN_CONFIG['max_text_length']}å­—ç¬¦
â€¢ ç¼“å­˜å¼€å¯: {'âœ“' if PLUGIN_CONFIG['cache_enabled'] else 'âœ—'}
â€¢ æ—¥å¿—çº§åˆ«: {PLUGIN_CONFIG['log_level']}
            """
            await ctx.reply(config_info.strip())
        
        elif command == '!md-help':
            help_text = """
Markdownè½¬å›¾ç‰‡æ’ä»¶ä½¿ç”¨å¸®åŠ©ï¼š

å‘½ä»¤æ ¼å¼ï¼š
â€¢ !md <markdownæ–‡æœ¬> - å°†Markdownæ–‡æœ¬è½¬æ¢ä¸ºå›¾ç‰‡
â€¢ !md-config - æŸ¥çœ‹å½“å‰æ’ä»¶é…ç½®
â€¢ !md-help - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

æ”¯æŒçš„Markdownè¯­æ³•ï¼š
â€¢ æ ‡é¢˜: # ## ### ç­‰
â€¢ ç²—ä½“: **æ–‡æœ¬** æˆ– __æ–‡æœ¬__
â€¢ æ–œä½“: *æ–‡æœ¬* æˆ– _æ–‡æœ¬_
â€¢ ä»£ç : `ä»£ç ` æˆ– ```ä»£ç å—```
â€¢ é“¾æ¥: [æ–‡æœ¬](URL)
â€¢ å›¾ç‰‡: ![alt](URL)
â€¢ åˆ—è¡¨: - æˆ– 1. 
â€¢ è¡¨æ ¼: | åˆ—1 | åˆ—2 |
â€¢ æ•°å­¦å…¬å¼: $å…¬å¼$ æˆ– $$å…¬å¼$$

ç¤ºä¾‹ï¼š
!md # æ ‡é¢˜\\nè¿™æ˜¯**ç²—ä½“**å’Œ*æ–œä½“*æ–‡æœ¬ã€‚
            """
            await ctx.reply(help_text.strip())